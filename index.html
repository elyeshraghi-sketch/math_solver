<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Ø±ÛŒØ§Ø¶ÛŒâ€ŒÙ†Ù…Ø§ Ù‡ÙˆØ´Ù…Ù†Ø¯ â€” Ø¹Ø±ÙØ§Ù† Ø­ÛŒØ¯Ø±ÛŒ | Ù…Ø¯Ø±Ø³Ù‡ Ø§Ø³Ø±Ø§Ø±</title>
  <script src="https://unpkg.com/mathjs@12.4.2/lib/browser/math.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Vazir:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #f8f9ff;
      --card: #fff;
      --text: #2c3e50;
      --primary: #2563eb;
      --success: #16a34a;
      --warning: #d97706;
      --error: #dc2626;
      --border: #e2e8f0;
    }
    .dark {
      --bg: #0f172a;
      --card: #1e293b;
      --text: #e2e8f0;
      --border: #334155;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Vazir', sans-serif;
      background: var(--bg);
      color: var(--text);
      padding: 16px;
      transition: all 0.3s ease;
      line-height: 1.6;
    }
    .container { max-width: 800px; margin: 0 auto; }
    header {
      text-align: center;
      padding: 20px 0 25px;
      margin-bottom: 20px;
      border-bottom: 2px solid var(--border);
    }
    .badge {
      display: inline-block;
      padding: 6px 20px;
      border-radius: 20px;
      font-weight: bold;
      margin: 4px 0;
      font-size: 18px;
    }
    .name-badge { background: var(--primary); color: white; }
    .school-badge { background: #7e22ce; color: white; }
    h1 { font-size: 2.1rem; margin: 12px 0 8px; }
    .subtitle { color: #64748b; font-size: 16px; }
    
    .input-area {
      background: var(--card);
      padding: 20px;
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      margin-bottom: 24px;
    }
    .input-group {
      display: flex;
      gap: 12px;
      margin: 16px 0;
    }
    #in {
      flex: 1;
      padding: 16px;
      font-size: 17px;
      border: 2px solid var(--border);
      border-radius: 12px;
      background: var(--card);
      color: var(--text);
      direction: ltr;
      text-align: left;
    }
    .btn-group {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    button {
      padding: 14px 20px;
      border: none;
      border-radius: 12px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .btn-solve { background: var(--primary); color: white; flex: 1; }
    .btn-voice { background: #16a34a; color: white; }
    .btn-report { background: #7e22ce; color: white; }
    button:hover { opacity: 0.9; transform: translateY(-2px); }
    
    #out { 
      background: var(--card);
      padding: 24px;
      border-radius: 16px;
      margin: 24px 0;
      min-height: 80px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      overflow: auto;
    }
    
    .error-tip {
      background: #fef3c7;
      border-right: 4px solid var(--warning);
      padding: 16px;
      border-radius: 10px;
      margin: 16px 0;
      font-size: 16px;
    }
    .step { 
      background: #dbeafe;
      border-right: 4px solid var(--primary);
      padding: 14px;
      border-radius: 10px;
      margin: 12px 0;
      font-size: 16px;
    }
    
    .history {
      background: var(--card);
      padding: 20px;
      border-radius: 16px;
      margin-top: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }
    .history-list {
      margin-top: 12px;
      display: grid;
      gap: 8px;
    }
    .history-item {
      padding: 10px 14px;
      background: rgba(37, 99, 235, 0.08);
      border-radius: 10px;
      cursor: pointer;
      font-family: monospace;
      font-size: 15px;
    }
    
    .toggle-btn {
      position: fixed;
      top: 20px;
      left: 20px;
      width: 48px;
      height: 48px;
      border-radius: 12px;
      background: var(--primary);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
      z-index: 100;
      font-size: 18px;
    }
    
    footer {
      text-align: center;
      margin-top: 30px;
      padding-top: 20px;
      border-top: 1px dashed var(--border);
      font-size: 14px;
      color: #64748b;
    }
    
    @media (max-width: 600px) {
      .input-group { flex-direction: column; }
      .btn-group { flex-direction: column; }
      button { width: 100%; }
      .toggle-btn { top: 10px; left: 10px; width: 44px; height: 44px; }
    }
  </style>
</head>
<body>
  <div class="toggle-btn" onclick="toggleTheme()">ğŸŒ“</div>
  
  <div class="container">
    <header>
      <div class="badge name-badge">Ø¹Ø±ÙØ§Ù† Ø­ÛŒØ¯Ø±ÛŒ</div>
      <div class="badge school-badge">Ù…Ø¯Ø±Ø³Ù‡ Ø§Ø³Ø±Ø§Ø±</div>
      <h1>Ø±ÛŒØ§Ø¶ÛŒâ€ŒÙ†Ù…Ø§ Ù‡ÙˆØ´Ù…Ù†Ø¯ ğŸ§ </h1>
      <p class="subtitle">Ù…Ø±Ø¨ÛŒ Ø´Ø®ØµÛŒ Ø±ÛŒØ§Ø¶ÛŒ â€” ØªØ´Ø®ÛŒØµ Ø§Ø´ØªØ¨Ø§Ù‡ â€¢ ÙˆØ±ÙˆØ¯ÛŒ ØµÙˆØªÛŒ â€¢ Ú¯Ø²Ø§Ø±Ø´ ÛŒØ§Ø¯Ú¯ÛŒØ±ÛŒ</p>
    </header>

    <div class="input-area">
      <input id="in" placeholder="Ù…Ø«Ø§Ù„: x^2=4 ÛŒØ§ plot sin(x)" value="(-2)^2">
      
      <div class="btn-group">
        <button class="btn-solve" onclick="go()">
          <span>âš¡ Ø­Ù„ Ú©Ù†</span>
        </button>
        <button class="btn-voice" onclick="startVoiceInput()" title="ÙˆØ±ÙˆØ¯ÛŒ Ø¨Ø§ ØµØ¯Ø§">
          <span>ğŸ™ï¸ ØµØ¯Ø§</span>
        </button>
        <button class="btn-report" onclick="generateReport()" title="Ú¯Ø²Ø§Ø±Ø´ ÛŒØ§Ø¯Ú¯ÛŒØ±ÛŒ">
          <span>ğŸ“Š Ú¯Ø²Ø§Ø±Ø´</span>
        </button>
      </div>
    </div>

    <div id="out">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…ÙˆØªÙˆØ± Ù‡ÙˆØ´Ù…Ù†Ø¯...</div>

    <div class="history">
      <strong>ØªØ§Ø±ÛŒØ®Ú†Ù‡Ù” ÙØ¹Ø§Ù„ÛŒØª:</strong>
      <div class="history-list" id="history-list"></div>
    </div>

    <footer>
      <p>Ù¾Ø±ÙˆÚ˜Ù‡Ù” Ø¬Ø´Ù†ÙˆØ§Ø±Ù‡Ù” Ø®ÙˆØ§Ø±Ø²Ù…ÛŒ Û±Û´Û°Û´ â€” Ø·Ø±Ø§Ø­ÛŒâ€ŒØ´Ø¯Ù‡ Ø¨Ø§ Ù‡ÙˆØ´ Ùˆ Ø¹Ø´Ù‚ ØªÙˆØ³Ø· Ø¹Ø±ÙØ§Ù† Ø­ÛŒØ¯Ø±ÛŒ</p>
      <p>Ø§ÙˆÙ„ÛŒÙ† Ø­Ù„â€ŒÚ¯Ø± Ø±ÛŒØ§Ø¶ÛŒ Ø§ÛŒØ±Ø§Ù†ÛŒ Ø¨Ø§ ØªØ´Ø®ÛŒØµ Ø§Ø´ØªØ¨Ø§Ù‡Ø§Øª Ø±Ø§ÛŒØ¬ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²ÛŒ</p>
    </footer>
  </div>

  <script>
    // ØªÙ…
    if (localStorage.getItem('theme') === 'dark') document.body.classList.add('dark');
    function toggleTheme() {
      document.body.classList.toggle('dark');
      localStorage.setItem('theme', document.body.classList.contains('dark') ? 'dark' : 'light');
    }

    // ØªØ§Ø±ÛŒØ®Ú†Ù‡
    let history = JSON.parse(localStorage.getItem('mathHistory') || '[]');
    let mistakes = JSON.parse(localStorage.getItem('mistakeLog') || '[]');
    
    function updateHistory() {
      const list = document.getElementById('history-list');
      list.innerHTML = history.slice(-8).reverse().map(q => 
        `<div class="history-item" onclick="setInput('${q.replace(/'/g, "\\'")}')" title="Ø§Ø¬Ø±Ø§">${q}</div>`
      ).join('');
    }

    function setInput(q) {
      document.getElementById('in').value = q;
      go();
    }

    // ğŸ”¥ Ù…ÙˆØªÙˆØ± ØªØ´Ø®ÛŒØµ Ø§Ø´ØªØ¨Ø§Ù‡Ø§Øª Ø±Ø§ÛŒØ¬ (Ø®ÙÙ†â€ŒØªØ±ÛŒÙ† Ø¨Ø®Ø´!)
    const commonMistakes = [
      { pattern: /$$-?\\d+$$\^\s*2\s*=\s*-?\d+/i, 
        check: (input) => /$$-\d+$$\^2/.test(input) && eval(input.split('=')[1]) < 0,
        message: "âš ï¸ Ø§Ø´ØªØ¨Ø§Ù‡ Ø±Ø§ÛŒØ¬: <strong>(-a)Â² = aÂ²</strong> (Ù‡Ù…ÛŒØ´Ù‡ Ù…Ø«Ø¨Øª Ø§Ø³Øª!).<br>Ù…Ø«Ø§Ù„: (-3)Â² = 9ØŒ Ù†Ù‡ -9." },
      
      { pattern: /1\/0/i, 
        check: () => true,
        message: "â™¾ï¸ Ù‡Ø´Ø¯Ø§Ø± Ø±ÛŒØ§Ø¶ÛŒ: <strong>ØªÙ‚Ø³ÛŒÙ… Ø¨Ø± ØµÙØ± ØªØ¹Ø±ÛŒÙ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª!</strong><br>Ø­Ø¯ Ú†Ù¾ Ùˆ Ø±Ø§Ø³Øª Ø¨ÛŒâ€ŒÙ†Ù‡Ø§ÛŒØª Ø¨Ø§ Ø¹Ù„Ø§Ù…Øª Ù…Ø®Ø§Ù„Ù Ø§Ø³Øª." },
      
      { pattern: /sin$$(\d+$$)/i, 
        check: (input) => {
          const match = input.match(/sin$$(\d+)$$/i);
          return match && parseInt(match[1]) > 2*Math.PI;
        },
        message: "ğŸ’¡ Ù†Ú©ØªÙ‡: <strong>ØªØ§Ø¨Ø¹â€ŒÙ‡Ø§ÛŒ Ù…Ø«Ù„Ø«Ø§ØªÛŒ Ù…Ø¹Ù…ÙˆÙ„Ø§Ù‹ Ø¨Ø§ Ø±Ø§Ø¯ÛŒØ§Ù† Ú©Ø§Ø± Ù…ÛŒâ€ŒÚ©Ù†Ù†Ø¯.</strong><br>Ø§Ú¯Ø± Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø¨Ø§ Ø¯Ø±Ø¬Ù‡ Ú©Ø§Ø± Ú©Ù†ÛŒØ¯ØŒ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯: <code>sin(30 deg)</code>" },
      
      { pattern: /sqrt$$-?\d+$$/i,
        check: (input) => /sqrt$$-\d+$$/.test(input),
        message: "ğŸ”´ Ø¯Ø± Ø§Ø¹Ø¯Ø§Ø¯ Ø­Ù‚ÛŒÙ‚ÛŒ: <strong>Ø±ÛŒØ´Ù‡Ù” Ø²ÙˆØ¬ Ø§Ø² Ø¹Ø¯Ø¯ Ù…Ù†ÙÛŒ ØªØ¹Ø±ÛŒÙ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</strong><br>Ø¯Ø± Ø§Ø¹Ø¯Ø§Ø¯ Ù…Ø®ØªÙ„Ø·: âˆš(-4) = 2i" },
      
      { pattern: /0\^0/i,
        check: () => true,
        message: "â“ <strong>0â°</strong> Ø¯Ø± Ø¨Ø±Ø®ÛŒ Ø´Ø§Ø®Ù‡â€ŒÙ‡Ø§ÛŒ Ø±ÛŒØ§Ø¶ÛŒ Ø¨Ø±Ø§Ø¨Ø± Û± ØªØ¹Ø±ÛŒÙ Ù…ÛŒâ€ŒØ´ÙˆØ¯ (Ù…Ø«Ù„ Ø¯Ù†Ø¨Ø§Ù„Ù‡â€ŒÙ‡Ø§)ØŒ Ùˆ Ø¯Ø± Ø¨Ø±Ø®ÛŒ Ù†Ø§Ù…Ø¹ÛŒÙ† Ø§Ø³Øª (Ù…Ø«Ù„ Ø­Ø¯).<br>Ø¯Ø± Ù…Ø­Ø§Ø³Ø¨Ø§Øª Ø¹Ø¯Ø¯ÛŒ Ù…Ø¹Ù…ÙˆÙ„Ø§Ù‹ = 1 Ø¯Ø± Ù†Ø¸Ø± Ú¯Ø±ÙØªÙ‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯." },
      
      { pattern: /log$$(0$$|-\d+)/i,
        check: (input) => /log$$(0|-\d+)/.test(input),
        message: "ğŸš« <strong>Ù„Ú¯Ø§Ø±ÛŒØªÙ… ØµÙØ± ÛŒØ§ Ø§Ø¹Ø¯Ø§Ø¯ Ù…Ù†ÙÛŒ Ø¯Ø± Ø§Ø¹Ø¯Ø§Ø¯ Ø­Ù‚ÛŒÙ‚ÛŒ ØªØ¹Ø±ÛŒÙ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</strong><br>Ø¯Ø§Ù…Ù†Ù‡Ù” log(x): x > 0" },
      
      { pattern: /derivative$$.*x.*$$.*x/i,
        check: (input) => input.includes('derivative(') && !input.includes(',x)'),
        message: "ğŸ”§ Ù†Ú©ØªÙ‡ ÙÙ†ÛŒ: Ø¨Ø±Ø§ÛŒ Ù…Ø´ØªÙ‚ Ù†Ø³Ø¨Øª Ø¨Ù‡ xØŒ Ø¨Ù‡ØªØ± Ø§Ø³Øª Ù…Ø´Ø®Øµ Ú©Ù†ÛŒØ¯:<br><code>derivative(x^2, x)</code>" }
    ];

    function detectMistake(input) {
      for (let rule of commonMistakes) {
        if (rule.pattern.test(input) && rule.check(input)) {
          return rule.message;
        }
      }
      return null;
    }

    // ğŸ™ï¸ ÙˆØ±ÙˆØ¯ÛŒ ØµÙˆØªÛŒ (ÙÙ‚Ø· Ù…Ø±ÙˆØ±Ú¯Ø±Ù‡Ø§ÛŒ Ù…Ø¯Ø±Ù†)
    let recognition;
    function startVoiceInput() {
      if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
        alert('Ù…Ø±ÙˆØ±Ú¯Ø± Ø´Ù…Ø§ Ø§Ø² ÙˆØ±ÙˆØ¯ÛŒ ØµÙˆØªÛŒ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒÚ©Ù†Ø¯. (Chrome/Firefox Ø¬Ø¯ÛŒØ¯ ØªÙˆØµÛŒÙ‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯)');
        return;
      }

      if (!recognition) {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SpeechRecognition();
        recognition.lang = 'fa-IR';
        recognition.continuous = false;
        recognition.interimResults = false;

        recognition.onresult = (event) => {
          const transcript = event.results[0][0].transcript;
          // ØªØ¨Ø¯ÛŒÙ„ Ú©Ù„Ù…Ø§Øª ÙØ§Ø±Ø³ÛŒ Ø¨Ù‡ Ø¹Ø¨Ø§Ø±Øª Ø±ÛŒØ§Ø¶ÛŒ (Ø³Ø§Ø¯Ù‡â€ŒØ´Ø¯Ù‡)
          let expr = transcript
            .replace(/Ø¨Ù‡ Ø¹Ù„Ø§ÙˆÙ‡/g, '+')
            .replace(/Ø¨Ù‡ Ø§Ø¶Ø§ÙÙ‡/g, '+')
            .replace(/Ø¨Ø¹Ù„Ø§ÙˆÙ‡/g, '+')
            .replace(/Ù…Ù†Ù‡Ø§ÛŒ/g, '-')
            .replace(/Ø¶Ø±Ø¨Ø¯Ø±/g, '*')
            .replace(/Ø¯Ø±/g, '*')
            .replace(/ØªÙ‚Ø³ÛŒÙ… Ø¨Ø±/g, '/')
            .replace(/Ù…Ø³Ø§ÙˆÛŒ/g, '=')
            .replace(/ØªÙˆØ§Ù†/g, '^')
            .replace(/Ø§ÛŒÚ©Ø³/g, 'x')
            .replace(/Ù¾ÛŒ/g, 'pi')
            .replace(/Ø±Ø§Ø¯ÛŒÚ©Ø§Ù„/g, 'sqrt')
            .replace(/Ø³ÛŒÙ†ÙˆØ³/g, 'sin')
            .replace(/Ú©Ø³ÛŒÙ†ÙˆØ³/g, 'cos')
            .replace(/ØªØ§Ù†Ú˜Ø§Ù†Øª/g, 'tan')
            .replace(/Ù„Ø§Ú¯/g, 'log')
            .replace(/\s+/g, '');
          
          document.getElementById('in').value = expr;
          go();
        };

        recognition.onerror = (event) => {
          console.error('Voice error:', event.error);
          alert('Ø®Ø·Ø§ Ø¯Ø± ØªØ´Ø®ÛŒØµ ØµØ¯Ø§. Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø§Ù…ØªØ­Ø§Ù† Ú©Ù†ÛŒØ¯.');
        };
      }

      recognition.start();
      document.querySelector('.btn-voice').innerHTML = 'ğŸ™ï¸ <b>Ø¯Ø± Ø­Ø§Ù„ Ú¯ÙˆØ´ Ø¯Ø§Ø¯Ù†...</b>';
      setTimeout(() => {
        document.querySelector('.btn-voice').innerHTML = 'ğŸ™ï¸ ØµØ¯Ø§';
      }, 5000);
    }

    // ğŸ“Š ØªÙˆÙ„ÛŒØ¯ Ú¯Ø²Ø§Ø±Ø´ ÛŒØ§Ø¯Ú¯ÛŒØ±ÛŒ (Ø¨Ø§ jsPDF)
    function generateReport() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF('p', 'mm', 'a4');
      
      // Ø¹Ù†ÙˆØ§Ù†
      doc.setFont('Vazir', 'bold');
      doc.setFontSize(20);
      doc.text('Ú¯Ø²Ø§Ø±Ø´ ÛŒØ§Ø¯Ú¯ÛŒØ±ÛŒ â€” Ø±ÛŒØ§Ø¶ÛŒâ€ŒÙ†Ù…Ø§ Ù‡ÙˆØ´Ù…Ù†Ø¯', 105, 20, { align: 'center' });
      
      doc.setFontSize(14);
      doc.text(`Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±: Ø¹Ø±ÙØ§Ù† Ø­ÛŒØ¯Ø±ÛŒ â€” Ù…Ø¯Ø±Ø³Ù‡ Ø§Ø³Ø±Ø§Ø±`, 20, 35);
      doc.text(`ØªØ§Ø±ÛŒØ®: ${new Date().toLocaleDateString('fa-IR')}`, 20, 45);
      
      // ØªØ§Ø±ÛŒØ®Ú†Ù‡
      doc.setFontSize(16);
      doc.text('ğŸ”¹ ØªØ§Ø±ÛŒØ®Ú†Ù‡Ù” Ø§Ø®ÛŒØ± (Ûµ Ù…ÙˆØ±Ø¯)', 20, 60);
      doc.setFontSize(12);
      let y = 70;
      history.slice(-5).reverse().forEach((item, i) => {
        doc.text(`${5-i}. ${item}`, 25, y);
        y += 8;
      });
      
      // Ø§Ø´ØªØ¨Ø§Ù‡Ø§Øª
      if (mistakes.length > 0) {
        y += 10;
        doc.setFontSize(16);
        doc.text('âš ï¸ Ø§Ù„Ú¯ÙˆÙ‡Ø§ÛŒ Ø§Ø´ØªØ¨Ø§Ù‡ Ø´Ù†Ø§Ø³Ø§ÛŒÛŒâ€ŒØ´Ø¯Ù‡', 20, y);
        y += 10;
        doc.setFontSize(12);
        const uniqueMistakes = [...new Set(mistakes)];
        uniqueMistakes.slice(0, 3).forEach(m => {
          doc.text(`â€¢ ${m}`, 25, y);
          y += 7;
        });
      }
      
      // Ù¾Ø§ÛŒØ§Ù†
      y += 15;
      doc.setFontSize(14);
      doc.text('Ø·Ø±Ø§Ø­ÛŒâ€ŒØ´Ø¯Ù‡ ØªÙˆØ³Ø· Ø¹Ø±ÙØ§Ù† Ø­ÛŒØ¯Ø±ÛŒ â€” Ø¬Ø´Ù†ÙˆØ§Ø±Ù‡Ù” Ø®ÙˆØ§Ø±Ø²Ù…ÛŒ Û±Û´Û°Û´', 105, y, { align: 'center' });
      
      doc.save('Ú¯Ø²Ø§Ø±Ø´_ÛŒØ§Ø¯Ú¯ÛŒØ±ÛŒ_Ø±ÛŒØ§Ø¶ÛŒâ€ŒÙ†Ù…Ø§.pdf');
    }

    // ØªØ§Ø¨Ø¹ Ø§ØµÙ„ÛŒ Ø­Ù„
    function go() {
      const q = document.getElementById('in').value.trim();
      const out = document.getElementById('out');
      out.innerHTML = 'Ø¯Ø± Ø­Ø§Ù„ ØªØ­Ù„ÛŒÙ„...';
      
      if (!q) { out.innerHTML = 'âŒ Ù„Ø·ÙØ§Ù‹ Ø¹Ø¨Ø§Ø±ØªÛŒ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.'; return; }

      // Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± ØªØ§Ø±ÛŒØ®Ú†Ù‡
      if (!history.includes(q)) {
        history.push(q);
        localStorage.setItem('mathHistory', JSON.stringify(history));
        updateHistory();
      }

      // ğŸ” Ø¨Ø±Ø±Ø³ÛŒ Ø§Ø´ØªØ¨Ø§Ù‡Ø§Øª Ø±Ø§ÛŒØ¬
      const mistake = detectMistake(q);
      if (mistake) {
        mistakes.push(mistake);
        localStorage.setItem('mistakeLog', JSON.stringify(mistakes));
        out.innerHTML = `<div class="error-tip">${mistake}</div>`;
        // Ø¨Ø¹Ø¯ Ø§Ø² 3 Ø«Ø§Ù†ÛŒÙ‡ØŒ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø±Ùˆ Ù‡Ù… Ø§Ù†Ø¬Ø§Ù… Ø¨Ø¯Ù‡
        setTimeout(() => {
          tryCalculate(q, out);
        }, 3000);
        return;
      }

      // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¹Ø§Ø¯ÛŒ
      tryCalculate(q, out);
    }

    function tryCalculate(q, out) {
      try {
        let res;
        if (q.toLowerCase().startsWith('plot ') || q.startsWith('Ø±Ø³Ù… ')) {
          out.innerHTML = 'Ø±Ø³Ù… Ù†Ù…ÙˆØ¯Ø§Ø± Ø¯Ø± Ø§ÛŒÙ† Ù†Ø³Ø®Ù‡Ù” Ø³Ø¨Ú© ØºÛŒØ±ÙØ¹Ø§Ù„ Ø§Ø³Øª.<br>Ø¯Ø± Ù†Ø³Ø®Ù‡Ù” Ú©Ø§Ù…Ù„: Ù†Ù…ÙˆØ¯Ø§Ø± ØªØ¹Ø§Ù…Ù„ÛŒ Ø¨Ø§ Plotly.';
          return;
        }
        
        if (q.includes('=')) {
          const [l,r] = q.split('=').map(x=>x.trim());
          const eq = `${l} - (${r})`;
          res = math.solve(math.parse(eq), 'x');
          res = Array.isArray(res) ? res.map(r => math.format(r, {precision: 6})) : [math.format(res, {precision: 6})];
          out.innerHTML = `<strong>âœ… Ø±ÛŒØ´Ù‡â€ŒÙ‡Ø§:</strong> ${res.join(', ')}`;
        } else {
          let expr = q
            .replace(/\bint\b/g,'integrate')
            .replace(/\bdiff\b/g,'derivative')
            .replace(/\bln\b/g,'log')
            .replace(/(\d+)!/g, 'factorial($1)');
          res = math.evaluate(expr);
          out.innerHTML = `<strong>âœ… Ù¾Ø§Ø³Ø®:</strong> <code>${math.format(res, {precision: 12})}</code>`;
        }
      } catch (e) {
        out.innerHTML = `âŒ Ø®Ø·Ø§: ${e.message || 'Ø¹Ø¨Ø§Ø±Øª Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª.'}`;
      }
    }

    // Ø´Ø±ÙˆØ¹
    updateHistory();
    setTimeout(go, 500);
  </script>
</body>
</html>
