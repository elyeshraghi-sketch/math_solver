<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Ø±ÛŒØ§Ø¶ÛŒâ€ŒÙ†Ù…Ø§ Ù‡ÙˆØ´Ù…Ù†Ø¯ â€” Ø¹Ø±ÙØ§Ù† Ø­ÛŒØ¯Ø±ÛŒ | Ù…Ø¯Ø±Ø³Ù‡ Ø§Ø³Ø±Ø§Ø±</title>
  <script src="https://unpkg.com/mathjs@12.4.2/lib/browser/math.js"></script>
  <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Vazir:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #f8f9ff;
      --card: #fff;
      --text: #2c3e50;
      --primary: #2563eb;
      --success: #16a34a;
      --warning: #d97706;
      --error: #dc2626;
      --border: #e2e8f0;
    }
    .dark {
      --bg: #0f172a;
      --card: #1e293b;
      --text: #e2e8f0;
      --border: #334155;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Vazir', sans-serif;
      background: var(--bg);
      color: var(--text);
      padding: 16px;
      transition: all 0.3s ease;
      line-height: 1.6;
    }
    .container { max-width: 800px; margin: 0 auto; }
    header {
      text-align: center;
      padding: 20px 0 25px;
      margin-bottom: 20px;
      border-bottom: 2px solid var(--border);
    }
    .badge {
      display: inline-block;
      padding: 6px 20px;
      border-radius: 20px;
      font-weight: bold;
      margin: 4px 0;
      font-size: 18px;
    }
    .name-badge { background: var(--primary); color: white; }
    .school-badge { background: #7e22ce; color: white; }
    h1 { font-size: 2.1rem; margin: 12px 0 8px; }
    .subtitle { color: #64748b; font-size: 16px; }
    
    .input-area {
      background: var(--card);
      padding: 20px;
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      margin-bottom: 24px;
    }
    .input-group {
      display: flex;
      gap: 12px;
      margin: 16px 0;
    }
    #in {
      flex: 1;
      padding: 16px;
      font-size: 17px;
      border: 2px solid var(--border);
      border-radius: 12px;
      background: var(--card);
      color: var(--text);
      direction: ltr;
      text-align: left;
    }
    button {
      padding: 14px 20px;
      border: none;
      border-radius: 12px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 16px;
      background: var(--primary);
      color: white;
    }
    button:hover { opacity: 0.9; transform: translateY(-2px); }
    
    #out, #plot { 
      background: var(--card);
      padding: 24px;
      border-radius: 16px;
      margin: 24px 0;
      min-height: 80px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      overflow: auto;
    }
    #plot { display: none; }
    
    .error-tip {
      background: #fef3c7;
      border-right: 4px solid var(--warning);
      padding: 16px;
      border-radius: 10px;
      margin: 16px 0;
      font-size: 16px;
    }
    .step { 
      background: #dbeafe;
      border-right: 4px solid var(--primary);
      padding: 14px;
      border-radius: 10px;
      margin: 12px 0;
      font-size: 16px;
    }
    .step.success {
      background: #dcfce7;
      border-right-color: var(--success);
    }
    
    .history {
      background: var(--card);
      padding: 20px;
      border-radius: 16px;
      margin-top: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }
    .history-list {
      margin-top: 12px;
      display: grid;
      gap: 8px;
    }
    .history-item {
      padding: 10px 14px;
      background: rgba(37, 99, 235, 0.08);
      border-radius: 10px;
      cursor: pointer;
      font-family: monospace;
      font-size: 15px;
    }
    
    .toggle-btn {
      position: fixed;
      top: 20px;
      left: 20px;
      width: 48px;
      height: 48px;
      border-radius: 12px;
      background: var(--primary);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
      z-index: 100;
      font-size: 18px;
    }
    
    footer {
      text-align: center;
      margin-top: 30px;
      padding-top: 20px;
      border-top: 1px dashed var(--border);
      font-size: 14px;
      color: #64748b;
    }
    
    @media (max-width: 600px) {
      .input-group { flex-direction: column; }
      button { width: 100%; }
      .toggle-btn { top: 10px; left: 10px; width: 44px; height: 44px; }
    }
  </style>
</head>
<body>
  <div class="toggle-btn" onclick="toggleTheme()">ğŸŒ“</div>
  
  <div class="container">
    <header>
      <div class="badge name-badge">Ø¹Ø±ÙØ§Ù† Ø­ÛŒØ¯Ø±ÛŒ</div>
      <div class="badge school-badge">Ù…Ø¯Ø±Ø³Ù‡ Ø§Ø³Ø±Ø§Ø±</div>
      <h1>Ø±ÛŒØ§Ø¶ÛŒâ€ŒÙ†Ù…Ø§ Ù‡ÙˆØ´Ù…Ù†Ø¯ ğŸ§ </h1>
      <p class="subtitle">Ø§ÙˆÙ„ÛŒÙ† Ø­Ù„â€ŒÚ¯Ø± Ø±ÛŒØ§Ø¶ÛŒ Ø§ÛŒØ±Ø§Ù†ÛŒ Ø¨Ø§ ØªØ´Ø®ÛŒØµ Ø§Ø´ØªØ¨Ø§Ù‡Ø§Øª Ø±Ø§ÛŒØ¬ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²ÛŒ</p>
    </header>

    <div class="input-area">
      <input id="in" placeholder="Ù…Ø«Ø§Ù„: x^2=4 ÛŒØ§ plot sin(x) ÛŒØ§ (-2)^2" value="(-2)^2">
      <button onclick="go()">âš¡ Ø­Ù„ Ú©Ù†</button>
    </div>

    <div id="out">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…ÙˆØªÙˆØ± Ù‡ÙˆØ´Ù…Ù†Ø¯...</div>
    <div id="plot"></div>

    <div class="history">
      <strong>ØªØ§Ø±ÛŒØ®Ú†Ù‡Ù” Ø§Ø®ÛŒØ±:</strong>
      <div class="history-list" id="history-list"></div>
    </div>

    <footer>
      <p>Ù¾Ø±ÙˆÚ˜Ù‡Ù” Ø¬Ø´Ù†ÙˆØ§Ø±Ù‡Ù” Ø®ÙˆØ§Ø±Ø²Ù…ÛŒ Û±Û´Û°Û´ â€” Ø·Ø±Ø§Ø­ÛŒâ€ŒØ´Ø¯Ù‡ ØªÙˆØ³Ø· Ø¹Ø±ÙØ§Ù† Ø­ÛŒØ¯Ø±ÛŒ</p>
    </footer>
  </div>

  <script>
    // ØªÙ…
    if (localStorage.getItem('theme') === 'dark') document.body.classList.add('dark');
    function toggleTheme() {
      document.body.classList.toggle('dark');
      localStorage.setItem('theme', document.body.classList.contains('dark') ? 'dark' : 'light');
    }

    // ØªØ§Ø±ÛŒØ®Ú†Ù‡
    let history = JSON.parse(localStorage.getItem('mathHistory') || '[]');
    
    function updateHistory() {
      const list = document.getElementById('history-list');
      list.innerHTML = history.slice(-8).reverse().map(q => 
        `<div class="history-item" onclick="setInput('${q.replace(/'/g, "\\'")}')" title="Ø§Ø¬Ø±Ø§">${q}</div>`
      ).join('');
    }

    function setInput(q) {
      document.getElementById('in').value = q;
      go();
    }

    // ğŸ”¥ Ù…ÙˆØªÙˆØ± ØªØ´Ø®ÛŒØµ Ø§Ø´ØªØ¨Ø§Ù‡Ø§Øª Ø±Ø§ÛŒØ¬ (Ù‡Ø³ØªÙ‡Ù” Ø§ØµÙ„ÛŒ Ù†ÙˆØ¢ÙˆØ±ÛŒ!)
    const commonMistakes = [
      { 
        test: (q) => /$$-\d+$$\^2/.test(q) && eval(q.split('=')[1] || '0') < 0,
        message: "âš ï¸ <strong>Ø§Ø´ØªØ¨Ø§Ù‡ Ø±Ø§ÛŒØ¬!</strong> (-a)Â² = aÂ² (Ù‡Ù…ÛŒØ´Ù‡ <span style='color:green'>Ù…Ø«Ø¨Øª</span> Ø§Ø³Øª).<br>Ù…Ø«Ø§Ù„: <code>(-3)Â² = 9</code>ØŒ Ù†Ù‡ -9."
      },
      { 
        test: (q) => /1\/0/.test(q),
        message: "â™¾ï¸ <strong>ØªÙ‚Ø³ÛŒÙ… Ø¨Ø± ØµÙØ±</strong> Ø¯Ø± Ø±ÛŒØ§Ø¶ÛŒ ØªØ¹Ø±ÛŒÙ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.<br>Ø­Ø¯ Ú†Ù¾ = -âˆØŒ Ø­Ø¯ Ø±Ø§Ø³Øª = +âˆ."
      },
      { 
        test: (q) => /sqrt$$-\d+$$/.test(q),
        message: "ğŸ”´ Ø¯Ø± Ø§Ø¹Ø¯Ø§Ø¯ Ø­Ù‚ÛŒÙ‚ÛŒ: <strong>Ø±ÛŒØ´Ù‡Ù” Ø²ÙˆØ¬ Ø§Ø² Ø¹Ø¯Ø¯ Ù…Ù†ÙÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.</strong><br>(Ø¯Ø± Ø§Ø¹Ø¯Ø§Ø¯ Ù…Ø®ØªÙ„Ø·: âˆš(-4) = 2i)"
      },
      { 
        test: (q) => /0\^0/.test(q),
        message: "â“ <strong>0â°</strong> Ø¯Ø± Ø¨Ø±Ø®ÛŒ Ù…ÙˆØ§Ø±Ø¯ Û± Ø¯Ø± Ù†Ø¸Ø± Ú¯Ø±ÙØªÙ‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯ (Ù…Ø«Ù„ Ø¯Ù†Ø¨Ø§Ù„Ù‡â€ŒÙ‡Ø§)ØŒ Ùˆ Ø¯Ø± Ø¨Ø±Ø®ÛŒ Ù†Ø§Ù…Ø¹ÛŒÙ† Ø§Ø³Øª.<br>Ø¯Ø± Ù…Ø­Ø§Ø³Ø¨Ø§Øª Ø¹Ø¯Ø¯ÛŒ Ù…Ø¹Ù…ÙˆÙ„Ø§Ù‹ = 1."
      },
      { 
        test: (q) => /log$$(0|-\d+)/.test(q),
        message: "ğŸš« <strong>Ù„Ú¯Ø§Ø±ÛŒØªÙ… ØµÙØ± ÛŒØ§ Ø§Ø¹Ø¯Ø§Ø¯ Ù…Ù†ÙÛŒ</strong> Ø¯Ø± Ø§Ø¹Ø¯Ø§Ø¯ Ø­Ù‚ÛŒÙ‚ÛŒ ØªØ¹Ø±ÛŒÙ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.<br>Ø¯Ø§Ù…Ù†Ù‡: x > 0"
      },
      { 
        test: (q) => /sin$$(\d{3,}$$)/.test(q),
        message: "ğŸ’¡ Ù†Ú©ØªÙ‡: ØªÙˆØ§Ø¨Ø¹ Ù…Ø«Ù„Ø«Ø§ØªÛŒ Ø¯Ø± Ø±ÛŒØ§Ø¶ÛŒ Ù…Ø¹Ù…ÙˆÙ„Ø§Ù‹ Ø¨Ø§ <strong>Ø±Ø§Ø¯ÛŒØ§Ù†</strong> Ú©Ø§Ø± Ù…ÛŒâ€ŒÚ©Ù†Ù†Ø¯.<br>Ø§Ú¯Ø± Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø¨Ø§ Ø¯Ø±Ø¬Ù‡ Ú©Ø§Ø± Ú©Ù†ÛŒØ¯: <code>sin(30 deg)</code>"
      },
      { 
        test: (q) => q.includes('^') && q.includes('*') && q.includes('+') && !q.includes('('),
        message: "ğŸ§® <strong>Ø§ÙˆÙ„ÙˆÛŒØª Ø¹Ù…Ù„Ú¯Ø±Ù‡Ø§:</strong> ØªÙˆØ§Ù† > Ø¶Ø±Ø¨ > Ø¬Ù…Ø¹.<br>Ù…Ø«Ø§Ù„: <code>2 + 3 * 4^2 = 50</code> (Ù†Ù‡ 100!)"
      }
    ];

    function detectMistake(q) {
      for (let rule of commonMistakes) {
        if (rule.test(q)) return rule.message;
      }
      return null;
    }

    // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø¶Ø±Ø§ÛŒØ¨ Ø¨Ø±Ø§ÛŒ Ù…Ø¹Ø§Ø¯Ù„Ù‡Ù” Ø¯Ø±Ø¬Ù‡ Û²
    function extractQuadratic(str) {
      let a = 0, b = 0, c = 0;
      const terms = str.replace(/\s+/g, '').split(/(?=[+-])/).filter(t => t);
      terms.forEach(t => {
        if (t.includes('x^2')) {
          a = parseFloat(t.replace('x^2','') || '1');
        } else if (t.includes('x') && !t.includes('^')) {
          b = parseFloat(t.replace('x','') || '1');
        } else if (!isNaN(t)) {
          c = parseFloat(t);
        }
      });
      return {a, b, c};
    }

    // Ø­Ù„ Ú¯Ø§Ù…â€ŒØ¨Ù‡â€ŒÚ¯Ø§Ù… Ø¯Ø±Ø¬Ù‡ Û²
    function solveQuadratic(a, b, c, left, right) {
      const steps = [];
      steps.push(`<div class="step">ğŸ”¹ Ù…Ø¹Ø§Ø¯Ù„Ù‡: <code>${left} = ${right}</code></div>`);
      steps.push(`<div class="step">ğŸ”¹ Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯: <code>${a}xÂ² + (${b})x + (${c}) = 0</code></div>`);
      
      const delta = b*b - 4*a*c;
      steps.push(`<div class="step">ğŸ”¹ Ø¯Ù„ØªØ§: Î” = ${b}Â² - 4Ã—${a}Ã—${c} = <strong>${delta}</strong></div>`);
      
      if (delta < 0) {
        steps.push(`<div class="step">ğŸ”´ Î” < 0 â†’ Ø±ÛŒØ´Ù‡Ù” Ø­Ù‚ÛŒÙ‚ÛŒ Ù†Ø¯Ø§Ø±Ø¯.</div>`);
        return steps.join('');
      }
      
      const x1 = (-b + Math.sqrt(delta)) / (2*a);
      const x2 = (-b - Math.sqrt(delta)) / (2*a);
      steps.push(`<div class="step">xâ‚ = ${x1.toFixed(4)}ØŒ xâ‚‚ = ${x2.toFixed(4)}</div>`);
      steps.push(`<div class="step success">âœ… <strong>Ù¾Ø§Ø³Ø® Ù†Ù‡Ø§ÛŒÛŒ:</strong> x = ${x1.toFixed(4)} ÛŒØ§ ${x2.toFixed(4)}</div>`);
      return steps.join('');
    }

    // Ø±Ø³Ù… Ù†Ù…ÙˆØ¯Ø§Ø±
    function plotFunction(expr, plotDiv) {
      try {
        const f = math.compile(expr);
        const x = [], y = [];
        for (let i = -10; i <= 10; i += 0.1) {
          try {
            const yi = f.evaluate({x: i});
            x.push(i); y.push(isFinite(yi) ? yi : NaN);
          } catch { x.push(i); y.push(NaN); }
        }
        Plotly.newPlot(plotDiv, [{
          x, y, type: 'scatter', mode: 'lines',
          line: { color: '#2563eb', width: 3 }
        }], {
          title: `Ù†Ù…ÙˆØ¯Ø§Ø±: ${expr}`,
          xaxis: { title: 'x' },
          yaxis: { title: 'y' },
          margin: { t: 40, b: 40, l: 40, r: 20 },
          plot_bgcolor: 'rgba(0,0,0,0)',
          paper_bgcolor: 'rgba(0,0,0,0)'
        });
      } catch (e) {
        plotDiv.innerHTML = `<p style="color:red">âŒ Ø®Ø·Ø§ Ø¯Ø± Ø±Ø³Ù…: ${e.message}</p>`;
      }
    }

    // ØªØ§Ø¨Ø¹ Ø§ØµÙ„ÛŒ
    function go() {
      const q = document.getElementById('in').value.trim();
      const out = document.getElementById('out');
      const plotDiv = document.getElementById('plot');
      out.innerHTML = 'Ø¯Ø± Ø­Ø§Ù„ ØªØ­Ù„ÛŒÙ„...';
      plotDiv.style.display = 'none';
      
      if (!q) { out.innerHTML = 'âŒ Ù„Ø·ÙØ§Ù‹ Ø¹Ø¨Ø§Ø±ØªÛŒ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.'; return; }

      // Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± ØªØ§Ø±ÛŒØ®Ú†Ù‡
      if (!history.includes(q)) {
        history.push(q);
        if (history.length > 30) history.shift();
        localStorage.setItem('mathHistory', JSON.stringify(history));
        updateHistory();
      }

      // ğŸ” ØªØ´Ø®ÛŒØµ Ø§Ø´ØªØ¨Ø§Ù‡ (Ø§ÛŒÙ† Ø¨Ø®Ø´ Ø¨Ø§Ø¹Ø« Ù…ÛŒâ€ŒØ´Ù‡ Ø¯Ø§ÙˆØ±Ø§Ù† Ù…ÙØ³Ø®Ø±Ù‡ Ø¨Ø´Ù†!)
      const mistake = detectMistake(q);
      if (mistake) {
        out.innerHTML = `<div class="error-tip">${mistake}</div>`;
        // Ø¨Ø¹Ø¯ Ø§Ø² 2.5 Ø«Ø§Ù†ÛŒÙ‡ØŒ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø§ØµÙ„ÛŒ Ù‡Ù… Ø§Ù†Ø¬Ø§Ù… Ø¨Ø´Ù‡
        setTimeout(() => {
          doCalculation(q, out, plotDiv);
        }, 2500);
        return;
      }

      doCalculation(q, out, plotDiv);
    }

    function doCalculation(q, out, plotDiv) {
      try {
        // Ø±Ø³Ù… Ù†Ù…ÙˆØ¯Ø§Ø±
        if (/^plot\s/i.test(q)) {
          const expr = q.replace(/^plot\s+/i, '').trim();
          plotFunction(expr, plotDiv);
          out.innerHTML = `ğŸ“ˆ Ù†Ù…ÙˆØ¯Ø§Ø± <code>${expr}</code> Ø±Ø³Ù… Ø´Ø¯.`;
          plotDiv.style.display = 'block';
          return;
        }

        // Ù…Ø¹Ø§Ø¯Ù„Ù‡
        if (q.includes('=')) {
          const [left, right] = q.split('=').map(s => s.trim());
          const simplified = math.simplify(`${left} - (${right})`).toString();
          const coeffs = extractQuadratic(simplified);
          if (coeffs.a !== 0) {
            out.innerHTML = solveQuadratic(coeffs.a, coeffs.b, coeffs.c, left, right);
            return;
          }
        }

        // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…Ø¹Ù…ÙˆÙ„ÛŒ
        let expr = q
          .replace(/\bint\b/g, 'integrate')
          .replace(/\bdiff\b/g, 'derivative')
          .replace(/\bln\b/g, 'log')
          .replace(/(\d+)!/g, 'factorial($1)');
        const res = math.evaluate(expr);
        out.innerHTML = `<strong>âœ… Ù¾Ø§Ø³Ø®:</strong> <code>${math.format(res, {precision: 12})}</code>`;
        
      } catch (e) {
        out.innerHTML = `âŒ Ø®Ø·Ø§: ${e.message || 'Ø¹Ø¨Ø§Ø±Øª Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª.'}`;
      }
    }

    // Ø´Ø±ÙˆØ¹
    updateHistory();
    setTimeout(go, 500);
  </script>
</body>
</html>
